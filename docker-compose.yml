version: '3.8'

# Configuration commune pour Ã©viter les rÃ©pÃ©titions (DRY)
x-common-config: &common-config
  image: julienisrt/smartsearchengine:v5.1.0
  # build: # DÃ©commentez pour builder localement si vous modifiez le code
  #   context: .
  #   dockerfile: Dockerfile
  environment:
    - TRANSFORMERS_CACHE=/root/.cache/huggingface
    - OCR_LANG=latin
    - PYTHONPATH=/app
    - METADATA_DB_PATH=/app/computed-data/metadata/metadata.db
    - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
    - TARGET_DOMAINS=food,medical,cars
    # CONFIGURATION LLM
    - OLLAMA_HOST=ollama
    - LLM_MODEL_NAME=mistral
    # Active la visibilitÃ© GPU pour PyTorch/Ollama
    - NVIDIA_VISIBLE_DEVICES=all
  volumes:
    - ./raw-datasets:/app/raw-datasets
    - ./computed-data:/app/computed-data
    - ./logs:/app/logs
    - ./model_cache:/root/.cache/huggingface
    - ./paddle_cache:/root/.paddleocr
  depends_on:
    - ollama
  # Activation du GPU pour CLIP / OCR / Ingestion
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: 1
            capabilities: [gpu]

services:
  # SERVICE 1 : Ingestion Manuelle
  # Usage : docker compose run --rm ingest -m r
  ingest:
    <<: *common-config
    container_name: engine_ingest
    stdin_open: true
    tty: true

  # SERVICE 2 : Surveillance (Watchdog)
  watcher:
    <<: *common-config
    container_name: engine_watcher
    restart: unless-stopped
    command: ["watch"]

  # SERVICE 3 : API de Recherche
  search:
    <<: *common-config
    container_name: engine_search
    ports:
      - "8000:8000"
    restart: unless-stopped
    command: ["serve"]

  # SERVICE 4 : OLLAMA (Cerveau LLM)
  ollama:
    image: ollama/ollama:latest
    container_name: smartsearch_ollama
    volumes:
      # PERSISTANCE : Stocke les modÃ¨les (Mistral, etc.) sur le disque hÃ´te
      # pour ne pas les retÃ©lÃ©charger Ã  chaque redÃ©marrage.
      - ./ollama_data:/root/.ollama
    ports:
      - "11434:11434"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]