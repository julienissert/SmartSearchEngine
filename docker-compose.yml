version: '3.8'

# Configuration commune pour éviter les répétitions (DRY)
x-common-config: &common-config
  image: julienisrt/smartsearchengine:latest
  # build: . # Décommentez pour builder localement si vous modifiez le code
  environment:
    - OCR_LANG=latin
    - PYTHONPATH=/app
    - METADATA_DB_PATH=/app/computed-data/metadata/metadata.db
    - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
  volumes:
    - ./raw-datasets:/app/raw-datasets
    - ./computed-data:/app/computed-data
    - ./logs:/app/logs
    - ./model_cache:/root/.cache/huggingface
    - ./paddle_cache:/root/.paddleocr

services:
  # SERVICE 1 : Ingestion Manuelle
  # Usage : docker compose run --rm ingest -m r
  ingest:
    <<: *common-config
    container_name: engine_ingest
    stdin_open: true
    tty: true
    # On n'active pas le GPU par défaut pour l'ingestion manuelle sauf besoin
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # SERVICE 2 : Surveillance (Watchdog)
  watcher:
    <<: *common-config
    container_name: engine_watcher
    restart: unless-stopped
    command: ["watch"]
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # SERVICE 3 : API de Recherche
  search:
    <<: *common-config
    container_name: engine_search
    ports:
      - "8000:8000"
    restart: unless-stopped
    command: ["serve"]
    # Optionnel : Activer le GPU si vos embeddings/recherche sont lourds
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]